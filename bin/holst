#!/usr/bin/env ruby
require 'rake'
require 'yaml'

# Parse command line options
arguments = ARGV
task = arguments.shift
target = arguments.shift || nil

# Load Rakefiles
FileList[File.join(File.dirname(__FILE__), '..', 'tasks', '*')].each {|tf| load tf }

# Load configuration files
CONFIG = FileList[File.join('config', '*.yml')].inject({}) do |config, path|
  config[path.pathmap('%n')] = YAML.load(File.read(path))
  config
end

pwd = Dir.pwd

if task == 'init' && !Dir.exist?(target)
  Dir.mkdir(target)
  pwd = File.expand_path(target)
end  

Dir.chdir(pwd) do
  begin
    Rake::Task[task].invoke((target unless nil))
  rescue Exception => e
    puts e.message
    puts e.backtrace
  end
end